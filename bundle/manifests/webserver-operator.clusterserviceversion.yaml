apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  name: webserver-operator.v1.0.36
  namespace: placeholder
  annotations:
    categories: Application Runtime
    capabilities: Basic Install
    description: An Ansible-based operator that deploys NGINX or Apache based on a WebServer CR.

    operators.operatorframework.io.bundle.package.v1: webserver-operator-dev
    operators.operatorframework.io.bundle.channels.v1: stable
    operators.operatorframework.io.bundle.channel.default.v1: stable

    containerImage: quay.io/philip860/webserver-operator:v1.0.36-dev

    alm-examples: >-
      [
        {
          "apiVersion": "example.com/v1alpha1",
          "kind": "WebServer",
          "metadata": { "name": "example-webserver" },
          "spec": {
            "type": "nginx",
            "replicas": 1,
            "port": 8080,
            "contentConfigMapName": ""
          }
        }
      ]

    features.operators.openshift.io/disconnected: "false"
    features.operators.openshift.io/fips-compliant: "false"
    features.operators.openshift.io/proxy-aware: "false"
    features.operators.openshift.io/tls-profiles: "false"
    features.operators.openshift.io/token-auth-aws: "false"
    features.operators.openshift.io/token-auth-azure: "false"
    features.operators.openshift.io/token-auth-gcp: "false"

    operators.operatorframework.io.bundle.mediatype.v1: registry+v1
    operators.operatorframework.io.bundle.manifests.v1: manifests/
    operators.operatorframework.io.bundle.metadata.v1: metadata/

    olm.skipRange: ">=1.0.0 <1.0.34"

spec:
  displayName: WebServer Operator
  description: |-
    The WebServer Operator manages WebServer custom resources which can
    deploy either NGINX or Apache HTTPD behind a Service and OpenShift Route.
  maturity: stable
  version: 1.0.36
  replaces: webserver-operator.v1.0.35

  provider:
    name: Duncan-Networks

  keywords:
    - nginx
    - apache
    - webserver
    - ansible

  relatedImages:
    - name: webserver-operator
      image: quay.io/philip860/webserver-operator:v1.0.36-dev

  install:
    strategy: deployment
    spec:
      deployments:
        - name: webserver-operator
          spec:
            selector:
              matchLabels:
                name: webserver-operator
            replicas: 1
            template:
              metadata:
                labels:
                  name: webserver-operator
              spec:
                serviceAccountName: webserver-operator
                containers:
                  - name: ansible-operator
                    image: quay.io/philip860/webserver-operator:v1.0.36-dev
                    imagePullPolicy: Always
                    env:
                      - name: WATCH_NAMESPACE
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.annotations['olm.targetNamespaces']
                      - name: POD_NAME
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.name
                      - name: OPERATOR_NAME
                        value: webserver-operator
                      - name: WEBSERVER_OPERATOR_VERSION
                        value: "v1.0.36-dev"
      permissions:
        - serviceAccountName: webserver-operator
          rules:
            - apiGroups: ["example.com"]
              resources: ["webservers","webservers/status","webservers/finalizers"]
              verbs: ["get","list","watch","create","update","patch","delete"]
            - apiGroups: ["apps"]
              resources: ["deployments","replicasets"]
              verbs: ["get","list","watch","create","update","patch","delete"]
            - apiGroups: [""]
              resources: ["pods"]
              verbs: ["get","list","watch"]
            - apiGroups: [""]
              resources: ["services","configmaps","secrets"]
              verbs: ["get","list","watch","create","update","patch","delete"]
            - apiGroups: [""]
              resources: ["events"]
              verbs: ["create","patch","update"]
            - apiGroups: ["route.openshift.io"]
              resources: ["routes"]
              verbs: ["get","list","watch","create","update","patch","delete"]

      clusterPermissions:
        - serviceAccountName: webserver-operator
          rules:
            - apiGroups: [""]
              resources: ["namespaces"]
              verbs: ["get","list","watch"]
            - apiGroups: ["route.openshift.io"]
              resources: ["routes"]
              verbs: ["get","list","watch"]

  customresourcedefinitions:
    owned:
      - name: webservers.example.com
        version: v1alpha1
        kind: WebServer
        displayName: WebServer
        description: Custom resource that declares an Apache or NGINX deployment.

        # Console form fields (OpenShift UI)
        specDescriptors:
          - path: type
            displayName: Web Server Type
            description: Select nginx or apache/httpd
            x-descriptors:
              - urn:alm:descriptor:com.tectonic.ui:select:nginx
              - urn:alm:descriptor:com.tectonic.ui:select:apache
              - urn:alm:descriptor:com.tectonic.ui:select:httpd
          - path: replicas
            displayName: Replicas
            description: Number of pod replicas
            x-descriptors:
              - urn:alm:descriptor:com.tectonic.ui:number
          - path: port
            displayName: Container Port
            description: Unprivileged port the container listens on
            x-descriptors:
              - urn:alm:descriptor:com.tectonic.ui:number
          - path: contentConfigMapName
            displayName: Custom Content ConfigMap Name
            description: >-
              Optional ConfigMap in the same namespace containing `index.html` (required) and optional `style.css`.
              If not found, the operator will fall back to defaults and report it in status.
            x-descriptors:
              - urn:alm:descriptor:com.tectonic.ui:text

  installModes:
    - type: OwnNamespace
      supported: true
    - type: SingleNamespace
      supported: true
    - type: MultiNamespace
      supported: false
    - type: AllNamespaces
      supported: true
