---
- hosts: localhost
  gather_facts: false

  vars:
    webserver_name: "{{ ansible_operator_meta.name }}"
    webserver_ns:   "{{ ansible_operator_meta.namespace }}"

    # Operator version stamp (override by env var in the operator deployment/CSV)
    operator_version: "{{ lookup('env', 'WEBSERVER_OPERATOR_VERSION') | default('dev-unknown', true) }}"

    nginx_image_default:  "docker.io/library/nginx:1.27-alpine"
    apache_image_default: "docker.io/library/httpd:2.4-alpine"

    # API flap resilience
    cr_read_retries: 12
    cr_read_delay: 5

  tasks:
    #################################################################
    # Read the WebServer CR (authoritative) so we always have .spec
    #################################################################
    - name: Read WebServer CR from API (authoritative, with retries)
      kubernetes.core.k8s_info:
        api_version: example.com/v1alpha1
        kind: WebServer
        namespace: "{{ webserver_ns }}"
        name: "{{ webserver_name }}"
      register: ws_cr
      retries: "{{ cr_read_retries }}"
      delay: "{{ cr_read_delay }}"
      until: (ws_cr.resources | default([]) | length) > 0

    - name: Fail if CR could not be read
      fail:
        msg: >-
          Unable to read WebServer {{ webserver_name }} in namespace {{ webserver_ns }}
          after {{ cr_read_retries }} retries (delay={{ cr_read_delay }}s).
          ws_cr.resources={{ ws_cr.resources | default([]) }}
      when: (ws_cr.resources | default([]) | length) == 0

    - name: Extract spec as dict (safe access)
      set_fact:
        spec_obj: "{{ ws_cr.resources[0].spec | default({}) }}"

    #################################################################
    # Normalize values from spec_obj
    #################################################################
    - name: Normalize server type + other spec values
      set_fact:
        server_type_raw: "{{ spec_obj.get('type', 'nginx') }}"
        server_type: "{{ (spec_obj.get('type', 'nginx')) | string | lower | trim }}"
        replicas: "{{ spec_obj.get('replicas', 1) | int }}"
        port: "{{ spec_obj.get('port', 8080) | int }}"

    - name: Validate server_type
      fail:
        msg: "Unsupported spec.type='{{ server_type_raw }}' (normalized='{{ server_type }}'). Use nginx, apache, or httpd."
      when: server_type not in ['nginx', 'apache', 'httpd']

    - name: Pick image based on type (allow spec.image override)
      set_fact:
        container_image: >-
          {{ (spec_obj.get('image', '') | string | trim | length > 0)
             | ternary(spec_obj.get('image', '') | string | trim,
                       (apache_image_default if server_type in ['apache','httpd'] else nginx_image_default)) }}

    - name: Set labels
      set_fact:
        labels:
          app.kubernetes.io/name: "{{ webserver_name }}"
          app.kubernetes.io/instance: "{{ webserver_name }}"
          app.kubernetes.io/managed-by: "webserver-operator"
          app: "{{ webserver_name }}"

    - name: Set probe path + container name
      set_fact:
        probe_path: "{{ '/healthz' if server_type in ['apache','httpd'] else '/' }}"
        container_name: "{{ 'apache' if server_type in ['apache','httpd'] else 'nginx' }}"

    #################################################################
    # Apache webroot (fix 403 on / + reliable health endpoint)
    #################################################################
    - name: Ensure Apache webroot ConfigMap exists (index.html + healthz)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-webroot"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            index.html: |
              <!doctype html>
              <html>
                <head><meta charset="utf-8" /><title>{{ webserver_name }}</title></head>
                <body>
                  <h1>{{ webserver_name }}</h1>
                  <p>Deployed by webserver-operator ({{ operator_version }}).</p>
                </body>
              </html>
            healthz: "ok\n"
      when: server_type in ['apache','httpd']

    #################################################################
    # Deployment
    #################################################################
    - name: Ensure Deployment exists for selected web server
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ webserver_name }}"
            template:
              metadata:
                labels: "{{ labels }}"
                annotations:
                  webserver-operator/version: "{{ operator_version }}"
              spec:
                volumes: >-
                  {{ (server_type in ['apache','httpd'])
                     | ternary(
                         [ { 'name': 'webroot', 'configMap': { 'name': webserver_name ~ '-webroot' } } ],
                         omit
                       )
                  }}
                containers:
                  - name: "{{ container_name }}"
                    image: "{{ container_image }}"
                    ports:
                      - name: http
                        containerPort: "{{ port }}"
                    volumeMounts: >-
                      {{ (server_type in ['apache','httpd'])
                         | ternary(
                             [ { 'name': 'webroot', 'mountPath': '/usr/local/apache2/htdocs', 'readOnly': true } ],
                             omit
                           )
                      }}
                    readinessProbe:
                      httpGet:
                        path: "{{ probe_path }}"
                        port: http
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: "{{ probe_path }}"
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 20

    #################################################################
    # Service
    #################################################################
    - name: Ensure Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            selector:
              app: "{{ webserver_name }}"
            ports:
              - name: http
                port: 80
                targetPort: http
                protocol: TCP

    #################################################################
    # Route (OpenShift)
    #################################################################
    - name: Ensure Route exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            to:
              kind: Service
              name: "{{ webserver_name }}"
            port:
              targetPort: http
            tls:
              termination: edge

    #################################################################
    # Update CR status
    #################################################################
    - name: Set status to Ready
      operator_sdk.util.k8s_status:
        api_version: example.com/v1alpha1
        kind: WebServer
        name: "{{ webserver_name }}"
        namespace: "{{ webserver_ns }}"
        status:
          phase: Ready
          operatorVersion: "{{ operator_version }}"
          message: "Operator {{ operator_version }} deployed {{ container_name }} with {{ replicas }} replica(s) on port {{ port }}"

    #################################################################
    # Final version banner (log signal)
    #################################################################
    - name: VERSION BANNER - operator version running
      debug:
        msg:
          - "============================================================"
          - "webserver-operator version: {{ operator_version }}"
          - "CR: {{ webserver_ns }}/{{ webserver_name }}"
          - "server_type={{ server_type }} image={{ container_image }}"
          - "replicas={{ replicas }} port={{ port }} probe_path={{ probe_path }}"
          - "============================================================"
