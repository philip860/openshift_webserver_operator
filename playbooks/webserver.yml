---
- hosts: localhost
  gather_facts: false

  vars:
    webserver_name: "{{ ansible_operator_meta.name }}"
    webserver_ns:   "{{ ansible_operator_meta.namespace }}"

    operator_version: "{{ lookup('env', 'WEBSERVER_OPERATOR_VERSION') | default('dev-unknown', true) }}"

    # OpenShift-friendly defaults
    nginx_image_default:  "nginxinc/nginx-unprivileged:stable-alpine"
    apache_image_default: "docker.io/library/httpd:2.4-alpine"

    cr_read_retries: 12
    cr_read_delay: 5

  tasks:
    #################################################################
    # Read the WebServer CR (authoritative)
    #################################################################
    - name: Read WebServer CR from API (authoritative, with retries)
      kubernetes.core.k8s_info:
        api_version: example.com/v1alpha1
        kind: WebServer
        namespace: "{{ webserver_ns }}"
        name: "{{ webserver_name }}"
      register: ws_cr
      retries: "{{ cr_read_retries }}"
      delay: "{{ cr_read_delay }}"
      until: (ws_cr.resources | default([]) | length) > 0

    - name: Fail if CR could not be read
      fail:
        msg: >-
          Unable to read WebServer {{ webserver_name }} in namespace {{ webserver_ns }}
          after {{ cr_read_retries }} retries (delay={{ cr_read_delay }}s).
          ws_cr.resources={{ ws_cr.resources | default([]) }}
      when: (ws_cr.resources | default([]) | length) == 0

    - name: Extract spec as dict (safe access)
      set_fact:
        spec_obj: "{{ ws_cr.resources[0].spec | default({}) }}"

    #################################################################
    # Normalize spec values
    #################################################################
    - name: Normalize server type + other spec values
      set_fact:
        server_type_raw: "{{ spec_obj.get('type', 'nginx') }}"
        server_type: "{{ (spec_obj.get('type', 'nginx')) | string | lower | trim }}"
        replicas: "{{ spec_obj.get('replicas', 1) | int }}"
        port: "{{ spec_obj.get('port', 8080) | int }}"

    - name: Validate server_type
      fail:
        msg: "Unsupported spec.type='{{ server_type_raw }}' (normalized='{{ server_type }}'). Use nginx, apache, or httpd."
      when: server_type not in ['nginx', 'apache', 'httpd']

    - name: Pick image based on type (allow spec.image override)
      set_fact:
        container_image: >-
          {{ (spec_obj.get('image', '') | string | trim | length > 0)
             | ternary(spec_obj.get('image', '') | string | trim,
                       (apache_image_default if server_type in ['apache','httpd'] else nginx_image_default)) }}

    - name: Set labels
      set_fact:
        labels:
          app.kubernetes.io/name: "{{ webserver_name }}"
          app.kubernetes.io/instance: "{{ webserver_name }}"
          app.kubernetes.io/managed-by: "webserver-operator"
          app: "{{ webserver_name }}"

    - name: Set probe path + container name
      set_fact:
        probe_path: "{{ '/healthz' if server_type in ['apache','httpd'] else '/' }}"
        container_name: "{{ 'apache' if server_type in ['apache','httpd'] else 'nginx' }}"

    #################################################################
    # Apache: config override to listen on {{ port }} and log to stdout
    #################################################################
    - name: Ensure Apache config ConfigMap exists (listen on unprivileged port + stdout logs)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-apache-conf"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            httpd.conf: |
              ServerName localhost
              Listen {{ port }}

              LoadModule mpm_event_module modules/mod_mpm_event.so
              LoadModule unixd_module modules/mod_unixd.so
              LoadModule authz_core_module modules/mod_authz_core.so
              LoadModule dir_module modules/mod_dir.so
              LoadModule mime_module modules/mod_mime.so
              LoadModule log_config_module modules/mod_log_config.so
              LoadModule alias_module modules/mod_alias.so

              PidFile /tmp/httpd.pid

              DocumentRoot "/usr/local/apache2/htdocs"
              <Directory "/usr/local/apache2/htdocs">
                  Require all granted
                  AllowOverride None
                  Options Indexes FollowSymLinks
              </Directory>

              DirectoryIndex index.html

              ErrorLog /proc/self/fd/2
              CustomLog /proc/self/fd/1 combined
      when: server_type in ['apache','httpd']

    #################################################################
    # Webroot for apache + nginx (index.html + healthz)
    #################################################################
    - name: Ensure webroot ConfigMap exists (index.html + healthz)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-webroot"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            index.html: |
              <!doctype html>
              <html>
                <head><meta charset="utf-8" /><title>{{ webserver_name }}</title></head>
                <body>
                  <h1>{{ webserver_name }}</h1>
                  <p>Deployed by webserver-operator ({{ operator_version }}).</p>
                </body>
              </html>
            healthz: "ok\n"

    #################################################################
    # NGINX: provide config that listens on {{ port }} and serves webroot
    # (avoids writing to /etc/nginx and avoids /var/cache perms)
    #################################################################
    - name: Ensure NGINX config ConfigMap exists (listen on {{ port }}, serve webroot)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-nginx-conf"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            default.conf: |
              server {
                listen       {{ port }};
                listen  [::]:{{ port }};
                server_name  _;
                root   /usr/share/nginx/html;

                location = /healthz {
                  default_type text/plain;
                  return 200 "ok\n";
                }

                location / {
                  try_files $uri $uri/ /index.html;
                }
              }
      when: server_type == 'nginx'

    #################################################################
    # Deployment (Apache path)
    #################################################################
    - name: Ensure Deployment exists (apache/httpd path)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ webserver_name }}"
            template:
              metadata:
                labels: "{{ labels }}"
                annotations:
                  webserver-operator/version: "{{ operator_version }}"
              spec:
                volumes:
                  - name: webroot
                    configMap:
                      name: "{{ webserver_name }}-webroot"
                  - name: apacheconf
                    configMap:
                      name: "{{ webserver_name }}-apache-conf"
                containers:
                  - name: "{{ container_name }}"
                    image: "{{ container_image }}"
                    command: ['httpd','-DFOREGROUND','-f','/opt/apache-conf/httpd.conf']
                    ports:
                      - name: http
                        containerPort: "{{ port }}"
                    volumeMounts:
                      - name: webroot
                        mountPath: /usr/local/apache2/htdocs
                        readOnly: true
                      - name: apacheconf
                        mountPath: /opt/apache-conf
                        readOnly: true
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 20
      when: server_type in ['apache','httpd']

    #################################################################
    # Deployment (NGINX path) - OpenShift-safe
    #################################################################
    - name: Ensure Deployment exists (nginx path)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ webserver_name }}"
            template:
              metadata:
                labels: "{{ labels }}"
                annotations:
                  webserver-operator/version: "{{ operator_version }}"
              spec:
                volumes:
                  - name: webroot
                    configMap:
                      name: "{{ webserver_name }}-webroot"
                  - name: nginxconf
                    configMap:
                      name: "{{ webserver_name }}-nginx-conf"
                      items:
                        - key: default.conf
                          path: default.conf
                  - name: nginxcache
                    emptyDir: {}
                  - name: nginxtmp
                    emptyDir: {}
                  - name: nginxrun
                    emptyDir: {}
                containers:
                  - name: "{{ container_name }}"
                    image: "{{ container_image }}"
                    ports:
                      - name: http
                        containerPort: "{{ port }}"
                    env:
                      # Force nginx temp/cache paths to writable locations
                      - name: NGINX_CLIENT_TEMP_PATH
                        value: /tmp/nginx/client_temp
                      - name: NGINX_PROXY_TEMP_PATH
                        value: /tmp/nginx/proxy_temp
                      - name: NGINX_FASTCGI_TEMP_PATH
                        value: /tmp/nginx/fastcgi_temp
                      - name: NGINX_UWSGI_TEMP_PATH
                        value: /tmp/nginx/uwsgi_temp
                      - name: NGINX_SCGI_TEMP_PATH
                        value: /tmp/nginx/scgi_temp
                    volumeMounts:
                      - name: webroot
                        mountPath: /usr/share/nginx/html
                        readOnly: true
                      # Provide server config without modifying image FS
                      - name: nginxconf
                        mountPath: /etc/nginx/conf.d/default.conf
                        subPath: default.conf
                        readOnly: true
                      # Writable locations
                      - name: nginxcache
                        mountPath: /var/cache/nginx
                      - name: nginxtmp
                        mountPath: /tmp/nginx
                      - name: nginxrun
                        mountPath: /var/run
                    readinessProbe:
                      httpGet:
                        path: /
                        port: http
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 20
      when: server_type == 'nginx'

    #################################################################
    # Service
    #################################################################
    - name: Ensure Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            selector:
              app: "{{ webserver_name }}"
            ports:
              - name: http
                port: 80
                targetPort: http
                protocol: TCP

    #################################################################
    # Route (OpenShift)
    #################################################################
    - name: Ensure Route exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            to:
              kind: Service
              name: "{{ webserver_name }}"
            port:
              targetPort: http
            tls:
              termination: edge

    #################################################################
    # Update CR status
    #################################################################
    - name: Set status to Ready
      operator_sdk.util.k8s_status:
        api_version: example.com/v1alpha1
        kind: WebServer
        name: "{{ webserver_name }}"
        namespace: "{{ webserver_ns }}"
        status:
          phase: Ready
          operatorVersion: "{{ operator_version }}"
          message: "Operator {{ operator_version }} deployed {{ container_name }} with {{ replicas }} replica(s) on port {{ port }}"

    #################################################################
    # Final version banner
    #################################################################
    - name: VERSION BANNER - operator version running
      debug:
        msg:
          - "============================================================"
          - "webserver-operator version: {{ operator_version }}"
          - "CR: {{ webserver_ns }}/{{ webserver_name }}"
          - "server_type={{ server_type }} image={{ container_image }}"
          - "replicas={{ replicas }} port={{ port }} probe_path={{ probe_path }}"
          - "============================================================"
