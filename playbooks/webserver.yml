---
- hosts: localhost
  gather_facts: false
  vars:
    webserver_name: "{{ ansible_operator_meta.name }}"
    webserver_ns:   "{{ ansible_operator_meta.namespace }}"

    # Normalize type to lowercase for consistent comparison
    server_type:    "{{ (spec.type | default('nginx')) | lower }}"
    replicas:       "{{ spec.replicas | default(1) | int }}"

    # Use a non-reserved var name for the container port and coerce to int
    container_port: "{{ spec.port | default(8080) | int }}"

    # OpenShift-friendly default images (non-root UBI)
    nginx_image_default:  "registry.access.redhat.com/ubi8/nginx-120"
    apache_image_default: "registry.access.redhat.com/ubi8/httpd-24"

  tasks:
    #################################################################
    # Detect delete vs normal reconcile
    #################################################################
    - name: Detect if WebServer CR is being deleted
      set_fact:
        being_deleted: >-
          {{ ansible_operator_meta.deletion_timestamp is defined
             and ansible_operator_meta.deletion_timestamp is not none }}

    #################################################################
    # Common labels (for create/update path)
    #################################################################
    - name: Set labels (create/update only)
      set_fact:
        labels:
          app.kubernetes.io/name: "{{ webserver_name }}"
          app.kubernetes.io/instance: "{{ webserver_name }}"
          app.kubernetes.io/managed-by: "webserver-operator"
          app: "{{ webserver_name }}"
      when: not being_deleted

    #################################################################
    # CREATE / UPDATE PATH
    #################################################################
    - block:
        - name: Determine default image for server type
          set_fact:
            default_image: >-
              {{ apache_image_default if server_type in ['apache', 'httpd']
                 else nginx_image_default }}

        - name: Pick final container image (override + trim)
          set_fact:
            container_image: >-
              {{ (
                  spec.image
                  if (spec.image is defined and (spec.image | string | length > 0))
                  else default_image
                ) | trim }}

        - name: Build Deployment definition as dict
          set_fact:
            deployment_definition:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: "{{ webserver_name }}"
                namespace: "{{ webserver_ns }}"
                labels: "{{ labels }}"
              spec:
                # Keep this as an integer, but quote the template for YAML parser
                replicas: "{{ replicas | int }}"
                selector:
                  matchLabels:
                    app: "{{ webserver_name }}"
                template:
                  metadata:
                    labels: "{{ labels }}"
                  spec:
                    containers:
                      - name: "{{ server_type }}"
                        image: "{{ container_image }}"
                        ports:
                          - name: http
                            # Also ensure this is an int
                            containerPort: "{{ container_port | int }}"
                        readinessProbe:
                          httpGet:
                            path: /
                            port: http
                          initialDelaySeconds: 5
                          periodSeconds: 10

        - name: Ensure Deployment exists for selected web server
          k8s:
            state: present
            definition: "{{ deployment_definition }}"

        - name: Ensure Service exists
          k8s:
            state: present
            definition:
              apiVersion: v1
              kind: Service
              metadata:
                name: "{{ webserver_name }}"
                namespace: "{{ webserver_ns }}"
                labels: "{{ labels }}"
              spec:
                selector:
                  app: "{{ webserver_name }}"
                ports:
                  - name: http
                    port: 80
                    # route to the container's named port "http" (container_port)
                    targetPort: http
                    protocol: TCP

        - name: Ensure Route exists
          k8s:
            state: present
            definition:
              apiVersion: route.openshift.io/v1
              kind: Route
              metadata:
                name: "{{ webserver_name }}"
                namespace: "{{ webserver_ns }}"
                labels: "{{ labels }}"
              spec:
                to:
                  kind: Service
                  name: "{{ webserver_name }}"
                port:
                  targetPort: http
                tls:
                  termination: edge

        - name: Set status to Ready
          operator_sdk.util.k8s_status:
            api_version: example.com/v1alpha1
            kind: WebServer
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            status:
              phase: Ready
              message: >-
                Deployed {{ server_type }} using image {{ container_image }}
                with {{ replicas }} replica(s) on port {{ container_port }}

      when: not being_deleted

    #################################################################
    # DELETE / CLEANUP PATH
    #################################################################
    - block:
        - name: Delete Route
          k8s:
            state: absent
            api_version: route.openshift.io/v1
            kind: Route
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"

        - name: Delete Service
          k8s:
            state: absent
            api_version: v1
            kind: Service
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"

        - name: Delete Deployment
          k8s:
            state: absent
            api_version: apps/v1
            kind: Deployment
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"

        - name: Update status to Deleted
          operator_sdk.util.k8s_status:
            api_version: example.com/v1alpha1
            kind: WebServer
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            status:
              phase: Deleted
              message: >-
                WebServer {{ webserver_name }} deleted; associated Deployment,
                Service, and Route have been removed.
      when: being_deleted
