---
- hosts: localhost
  gather_facts: false

  vars:
    webserver_name: "{{ ansible_operator_meta.name }}"
    webserver_ns:   "{{ ansible_operator_meta.namespace }}"

    operator_version: "{{ lookup('env', 'WEBSERVER_OPERATOR_VERSION') | default('dev-unknown', true) }}"

    nginx_image_default:  "nginxinc/nginx-unprivileged:stable-alpine"
    apache_image_default: "docker.io/library/httpd:2.4-alpine"

    cr_read_retries: 12
    cr_read_delay: 5

  tasks:
    - name: Read WebServer CR from API (authoritative, with retries)
      kubernetes.core.k8s_info:
        api_version: example.com/v1alpha1
        kind: WebServer
        namespace: "{{ webserver_ns }}"
        name: "{{ webserver_name }}"
      register: ws_cr
      retries: "{{ cr_read_retries }}"
      delay: "{{ cr_read_delay }}"
      until: (ws_cr.resources | default([]) | length) > 0

    - name: Fail if CR could not be read
      fail:
        msg: >-
          Unable to read WebServer {{ webserver_name }} in namespace {{ webserver_ns }}
          after {{ cr_read_retries }} retries (delay={{ cr_read_delay }}s).
          ws_cr.resources={{ ws_cr.resources | default([]) }}
      when: (ws_cr.resources | default([]) | length) == 0

    - name: Extract spec as dict (safe access)
      set_fact:
        spec_obj: "{{ ws_cr.resources[0].spec | default({}) }}"

    - name: Normalize server type + other spec values
      set_fact:
        server_type_raw: "{{ spec_obj.get('type', 'nginx') }}"
        server_type: "{{ (spec_obj.get('type', 'nginx')) | string | lower | trim }}"
        replicas: "{{ spec_obj.get('replicas', 1) | int }}"
        port: "{{ spec_obj.get('port', 8080) | int }}"
        custom_content_cm: "{{ spec_obj.get('contentConfigMapName', '') | string | trim }}"

    - name: Validate server_type
      fail:
        msg: "Unsupported spec.type='{{ server_type_raw }}' (normalized='{{ server_type }}'). Use nginx, apache, or httpd."
      when: server_type not in ['nginx', 'apache', 'httpd']

    - name: Pick image based on type (allow spec.image override)
      set_fact:
        container_image: >-
          {{ (spec_obj.get('image', '') | string | trim | length > 0)
             | ternary(spec_obj.get('image', '') | string | trim,
                       (apache_image_default if server_type in ['apache','httpd'] else nginx_image_default)) }}

    - name: Set labels
      set_fact:
        labels:
          app.kubernetes.io/name: "{{ webserver_name }}"
          app.kubernetes.io/instance: "{{ webserver_name }}"
          app.kubernetes.io/managed-by: "webserver-operator"
          app: "{{ webserver_name }}"

    - name: Set probe path + container name
      set_fact:
        probe_path: "{{ '/healthz' if server_type in ['apache','httpd'] else '/' }}"
        container_name: "{{ 'apache' if server_type in ['apache','httpd'] else 'nginx' }}"

    #################################################################
    # Default content (index.html + style.css) + healthz (separate CM)
    #################################################################
    - name: Ensure default webroot ConfigMap exists (index.html + style.css)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-webroot"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            index.html: |
              <!doctype html>
              <html>
                <head>
                  <meta charset="utf-8" />
                  <title>{{ webserver_name }}</title>
                  <link rel="stylesheet" href="style.css">
                </head>
                <body>
                  <div class="wrap">
                    <h1>{{ webserver_name }}</h1>
                    <p>Deployed by webserver-operator ({{ operator_version }}).</p>
                    <p class="hint">Tip: set <code>spec.contentConfigMapName</code> to override this page.</p>
                  </div>
                </body>
              </html>
            style.css: |
              body { font-family: Arial, sans-serif; margin: 2rem; }
              .wrap { max-width: 900px; }
              .hint { opacity: 0.8; }

    - name: Ensure healthz ConfigMap exists (always present for apache probe)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-healthz"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            healthz: "ok\n"

    #################################################################
    # Optional custom content ConfigMap lookup
    # - must exist
    # - must include index.html key to activate
    # - style.css is optional
    #################################################################
    - name: Lookup custom content ConfigMap if specified
      kubernetes.core.k8s_info:
        api_version: v1
        kind: ConfigMap
        namespace: "{{ webserver_ns }}"
        name: "{{ custom_content_cm }}"
      register: custom_cm_info
      when: custom_content_cm | length > 0

    - name: Determine whether custom content is usable
      set_fact:
        custom_cm_found: "{{ (custom_cm_info.resources | default([]) | length) > 0 }}"
        custom_cm_has_index: >-
          {{
            (custom_cm_info.resources | default([]) | length) > 0 and
            ('index.html' in (custom_cm_info.resources[0].data | default({})).keys())
          }}
        custom_cm_has_css: >-
          {{
            (custom_cm_info.resources | default([]) | length) > 0 and
            ('style.css' in (custom_cm_info.resources[0].data | default({})).keys())
          }}
      when: custom_content_cm | length > 0

    - name: Compute custom content mode flags
      set_fact:
        use_custom_content: >-
          {{
            (custom_content_cm | length > 0) and
            (custom_cm_found | default(false)) and
            (custom_cm_has_index | default(false))
          }}
        custom_content_reason: >-
          {% if custom_content_cm | length == 0 %}
          none
          {% elif not (custom_cm_found | default(false)) %}
          not_found
          {% elif not (custom_cm_has_index | default(false)) %}
          missing_index_html
          {% else %}
          ok
          {% endif %}

    #################################################################
    # Apache config CM (unchanged)
    #################################################################
    - name: Ensure Apache config ConfigMap exists (listen on unprivileged port + stdout logs)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-apache-conf"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            httpd.conf: |
              ServerName localhost
              Listen {{ port }}

              LoadModule mpm_event_module modules/mod_mpm_event.so
              LoadModule unixd_module modules/mod_unixd.so
              LoadModule authz_core_module modules/mod_authz_core.so
              LoadModule dir_module modules/mod_dir.so
              LoadModule mime_module modules/mod_mime.so
              LoadModule log_config_module modules/mod_log_config.so
              LoadModule alias_module modules/mod_alias.so

              PidFile /tmp/httpd.pid

              DocumentRoot "/usr/local/apache2/htdocs"
              <Directory "/usr/local/apache2/htdocs">
                  Require all granted
                  AllowOverride None
                  Options Indexes FollowSymLinks
              </Directory>

              DirectoryIndex index.html

              ErrorLog /proc/self/fd/2
              CustomLog /proc/self/fd/1 combined
      when: server_type in ['apache','httpd']

    #################################################################
    # NGINX config CM (unchanged)
    #################################################################
    - name: Ensure NGINX config ConfigMap exists (listen on {{ port }}, serve webroot)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ webserver_name }}-nginx-conf"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          data:
            default.conf: |
              server {
                listen       {{ port }};
                listen  [::]:{{ port }};
                server_name  _;
                root   /usr/share/nginx/html;

                location = /healthz {
                  default_type text/plain;
                  return 200 "ok\n";
                }

                location / {
                  try_files $uri $uri/ /index.html;
                }
              }
      when: server_type == 'nginx'

    #################################################################
    # Build the webroot volume definition (default vs custom+healthz)
    #
    # - Default mode: mount {{name}}-webroot (index+css) + healthz
    # - Custom mode: mount user CM (index required) + healthz
    #
    # We use a projected volume so Apache always gets /healthz.
    #################################################################
    - name: Build projected webroot volume sources
      set_fact:
        webroot_project_sources: >-
          {{
            (
              [ {'configMap': {'name': (custom_content_cm if use_custom_content else (webserver_name ~ '-webroot')) }} ]
              +
              [ {'configMap': {'name': (webserver_name ~ '-healthz') }} ]
            )
          }}

    #################################################################
    # Deployment (Apache path)
    #################################################################
    - name: Ensure Deployment exists (apache/httpd path)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ webserver_name }}"
            template:
              metadata:
                labels: "{{ labels }}"
                annotations:
                  webserver-operator/version: "{{ operator_version }}"
              spec:
                volumes:
                  - name: webroot
                    projected:
                      sources: "{{ webroot_project_sources }}"
                  - name: apacheconf
                    configMap:
                      name: "{{ webserver_name }}-apache-conf"
                containers:
                  - name: "{{ container_name }}"
                    image: "{{ container_image }}"
                    command: ['httpd','-DFOREGROUND','-f','/opt/apache-conf/httpd.conf']
                    ports:
                      - name: http
                        containerPort: "{{ port }}"
                    volumeMounts:
                      - name: webroot
                        mountPath: /usr/local/apache2/htdocs
                        readOnly: true
                      - name: apacheconf
                        mountPath: /opt/apache-conf
                        readOnly: true
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 20
      when: server_type in ['apache','httpd']

    #################################################################
    # Deployment (NGINX path)
    #################################################################
    - name: Ensure Deployment exists (nginx path)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ webserver_name }}"
            template:
              metadata:
                labels: "{{ labels }}"
                annotations:
                  webserver-operator/version: "{{ operator_version }}"
              spec:
                volumes:
                  - name: webroot
                    projected:
                      sources: "{{ webroot_project_sources }}"
                  - name: nginxconf
                    configMap:
                      name: "{{ webserver_name }}-nginx-conf"
                      items:
                        - key: default.conf
                          path: default.conf
                  - name: nginxcache
                    emptyDir: {}
                  - name: nginxtmp
                    emptyDir: {}
                  - name: nginxrun
                    emptyDir: {}
                containers:
                  - name: "{{ container_name }}"
                    image: "{{ container_image }}"
                    ports:
                      - name: http
                        containerPort: "{{ port }}"
                    env:
                      - name: NGINX_CLIENT_TEMP_PATH
                        value: /tmp/nginx/client_temp
                      - name: NGINX_PROXY_TEMP_PATH
                        value: /tmp/nginx/proxy_temp
                      - name: NGINX_FASTCGI_TEMP_PATH
                        value: /tmp/nginx/fastcgi_temp
                      - name: NGINX_UWSGI_TEMP_PATH
                        value: /tmp/nginx/uwsgi_temp
                      - name: NGINX_SCGI_TEMP_PATH
                        value: /tmp/nginx/scgi_temp
                    volumeMounts:
                      - name: webroot
                        mountPath: /usr/share/nginx/html
                        readOnly: true
                      - name: nginxconf
                        mountPath: /etc/nginx/conf.d/default.conf
                        subPath: default.conf
                        readOnly: true
                      - name: nginxcache
                        mountPath: /var/cache/nginx
                      - name: nginxtmp
                        mountPath: /tmp/nginx
                      - name: nginxrun
                        mountPath: /var/run
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 5
                      periodSeconds: 10
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 20
      when: server_type == 'nginx'

    #################################################################
    # Service
    #################################################################
    - name: Ensure Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            selector:
              app: "{{ webserver_name }}"
            ports:
              - name: http
                port: 80
                targetPort: http
                protocol: TCP

    #################################################################
    # Route
    #################################################################
    - name: Ensure Route exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ webserver_name }}"
            namespace: "{{ webserver_ns }}"
            labels: "{{ labels }}"
            annotations:
              webserver-operator/version: "{{ operator_version }}"
          spec:
            to:
              kind: Service
              name: "{{ webserver_name }}"
            port:
              targetPort: http
            tls:
              termination: edge

    #################################################################
    # Status message: clearly report fallback vs custom content
    #################################################################
    - name: Compute status message
      set_fact:
        status_content_msg: >-
          {% if custom_content_cm | length == 0 %}
          Using default content (no contentConfigMapName specified).
          {% elif use_custom_content %}
          Using custom content from ConfigMap '{{ custom_content_cm }}' (index.html{{ ' + style.css' if (custom_cm_has_css | default(false)) else '' }}).
          {% else %}
          ConfigMap '{{ custom_content_cm }}' could not be used (reason={{ custom_content_reason }}). Falling back to default content.
          {% endif %}

    - name: Set status to Ready
      operator_sdk.util.k8s_status:
        api_version: example.com/v1alpha1
        kind: WebServer
        name: "{{ webserver_name }}"
        namespace: "{{ webserver_ns }}"
        status:
          phase: Ready
          operatorVersion: "{{ operator_version }}"
          message: >-
            Operator {{ operator_version }} deployed {{ container_name }} with {{ replicas }} replica(s) on port {{ port }}.
            {{ status_content_msg }}

    - name: VERSION BANNER - operator version running
      debug:
        msg:
          - "============================================================"
          - "webserver-operator version: {{ operator_version }}"
          - "CR: {{ webserver_ns }}/{{ webserver_name }}"
          - "server_type={{ server_type }} image={{ container_image }}"
          - "replicas={{ replicas }} port={{ port }} probe_path={{ probe_path }}"
          - "custom_content_cm={{ custom_content_cm }} use_custom_content={{ use_custom_content }} reason={{ custom_content_reason }}"
          - "============================================================"
